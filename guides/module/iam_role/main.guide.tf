# ==========================================================
# ğŸ“Œ å¤‰æ•°å®šç¾©ï¼ˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å¤–éƒ¨ã‹ã‚‰æ¸¡ã›ã‚‹ã‚ˆã†ã«ã™ã‚‹ï¼‰
# ==========================================================

# IAM ãƒ­ãƒ¼ãƒ«ã®åå‰ï¼ˆä¾‹: ecs-task-roleï¼‰
variable "name" {}

# IAM ãƒãƒªã‚·ãƒ¼ã® JSONï¼ˆå¤–éƒ¨ã‹ã‚‰æ¸¡ã™ï¼‰
variable "policy" {}

# ã“ã® IAM ãƒ­ãƒ¼ãƒ«ã‚’åˆ©ç”¨ã™ã‚‹ AWS ã‚µãƒ¼ãƒ“ã‚¹ï¼ˆä¾‹: "ecs-tasks.amazonaws.com"ï¼‰
variable "identifier" {}

# ==========================================================
# ğŸ“Œ IAM ãƒ­ãƒ¼ãƒ«ã®ä½œæˆ
# ==========================================================

resource "aws_iam_role" "default" {
  name               = var.name  # IAM ãƒ­ãƒ¼ãƒ«ã®åå‰
  assume_role_policy = data.aws_iam_policy_document.assume_role.json  # ãƒ­ãƒ¼ãƒ«ã‚’å¼•ãå—ã‘ã‚‹ãƒãƒªã‚·ãƒ¼
}

# IAM ãƒ­ãƒ¼ãƒ«ã®ä¿¡é ¼ãƒãƒªã‚·ãƒ¼ã‚’å®šç¾©ï¼ˆã©ã® AWS ã‚µãƒ¼ãƒ“ã‚¹ãŒã“ã®ãƒ­ãƒ¼ãƒ«ã‚’åˆ©ç”¨ã§ãã‚‹ã‹ï¼‰
data "aws_iam_policy_document" "assume_role" {
  statement {
    actions = ["sts:AssumeRole"]  # ãƒ­ãƒ¼ãƒ«ã®å¼•ãå—ã‘ã‚’è¨±å¯

    principals {
      type        = "Service"
      identifiers = [var.identifier]  # æŒ‡å®šã•ã‚ŒãŸ AWS ã‚µãƒ¼ãƒ“ã‚¹ã®ã¿è¨±å¯ï¼ˆä¾‹: "ecs-tasks.amazonaws.com"ï¼‰
    }
  }
}

# ==========================================================
# ğŸ“Œ IAM ãƒãƒªã‚·ãƒ¼ã®ä½œæˆ
# ==========================================================

resource "aws_iam_policy" "default" {
  name   = var.name  # ãƒãƒªã‚·ãƒ¼ã®åå‰ï¼ˆãƒ­ãƒ¼ãƒ«åã¨åŒã˜ï¼‰
  policy = var.policy  # å¤–éƒ¨ã‹ã‚‰æ¸¡ã•ã‚Œã‚‹ JSON ã®ãƒãƒªã‚·ãƒ¼ã‚’é©ç”¨
}

# ==========================================================
# ğŸ“Œ IAM ãƒ­ãƒ¼ãƒ«ã¨ãƒãƒªã‚·ãƒ¼ã®é–¢é€£ä»˜ã‘
# ==========================================================

resource "aws_iam_role_policy_attachment" "default" {
  role       = aws_iam_role.default.name  # ä½œæˆã—ãŸ IAM ãƒ­ãƒ¼ãƒ«
  policy_arn = aws_iam_policy.default.arn  # ä½œæˆã—ãŸ IAM ãƒãƒªã‚·ãƒ¼
}

# ==========================================================
# ğŸ“Œ å‡ºåŠ›ï¼ˆTerraform å®Ÿè¡Œå¾Œã« IAM ãƒ­ãƒ¼ãƒ«ã® ARN ã‚’ç¢ºèªã§ãã‚‹ï¼‰
# ==========================================================

output "iam_role_arn" {
  value = aws_iam_role.default.arn
}

output "iam_role_name" {
  value = aws_iam_role.default.name
}


# ğŸ”¹ ã©ã‚“ãªæ™‚ã«ä½¿ã†ï¼Ÿ
# âœ… ECS ã‚¿ã‚¹ã‚¯ã«æ¨©é™ã‚’ä»˜ä¸ã—ãŸã„ã¨ã

# ä¾‹: ECS ã®ã‚³ãƒ³ãƒ†ãƒŠãŒ S3 ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹
# âœ… Lambda ã«ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ã‚’ä»˜ä¸ã—ãŸã„ã¨ã

# ä¾‹: Lambda é–¢æ•°ãŒ DynamoDB ã¸æ›¸ãè¾¼ã¿ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹
# âœ… EC2 ã«æ¨©é™ã‚’ä»˜ä¸ã—ãŸã„ã¨ã

# ä¾‹: EC2 ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒ SSM ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚¹ãƒˆã‚¢ã‹ã‚‰ç’°å¢ƒå¤‰æ•°ã‚’å–å¾—ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹


# å¤–éƒ¨ã® Terraform ã‚³ãƒ¼ãƒ‰ã§ã“ã® IAM ãƒ­ãƒ¼ãƒ«ã‚’åˆ©ç”¨ã™ã‚‹ã¨ãã€module ã‚’ä½¿ã£ã¦ç°¡å˜ã«å‘¼ã³å‡ºã›ã¾ã™
# ```
# module "ecs_task_role" {
#   source     = "./iam_role"  # ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ãƒ‘ã‚¹ï¼ˆãƒªãƒ¢ãƒ¼ãƒˆã®å ´åˆã¯ GitHub ã‚„ S3 ã‚’æŒ‡å®šï¼‰
#   name       = "ecs-task-role"
#   identifier = "ecs-tasks.amazonaws.com"

#   policy = <<EOF
# {
#   "Version": "2012-10-17",
#   "Statement": [
#     {
#       "Effect": "Allow",
#       "Action": [
#         "s3:GetObject",
#         "s3:PutObject"
#       ],
#       "Resource": "arn:aws:s3:::my-bucket/*"
#     }
#   ]
# }
# EOF
# }
# ```